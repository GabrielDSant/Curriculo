# ========================================
# ğŸš€ TUTORIAL COMPLETO: CONFIGURAÃ‡ÃƒO DO SERVIDOR 
# CURRÃCULO INTERATIVO EM BASH
# ========================================

## ğŸ“‹ PRÃ‰-REQUISITOS
- Servidor Linux (Ubuntu/Debian recomendado)
- Acesso root ou sudo
- SSH configurado e funcionando
- Bash 4.0+ instalado

## ğŸ› ï¸ PASSO 1: PREPARAÃ‡ÃƒO DO AMBIENTE

# 1.1 - Criar diretÃ³rio base
sudo mkdir -p /opt/curriculo
sudo mkdir -p /opt/curriculo/{modulos,utils,ascii}

# 1.2 - Copiar todos os arquivos do currÃ­culo para /opt/curriculo/
# (FaÃ§a upload dos arquivos via SCP, SFTP ou Git)

# 1.3 - Definir permissÃµes corretas
sudo chown -R root:root /opt/curriculo
sudo chmod 755 /opt/curriculo
sudo chmod +x /opt/curriculo/curriculo.sh
sudo chmod +x /opt/curriculo/modulos/*.sh
sudo chmod 644 /opt/curriculo/utils/*.sh
sudo chmod 644 /opt/curriculo/ascii/*

## ğŸ” PASSO 2: CRIAR USUÃRIO RESTRITO

# 2.1 - Criar usuÃ¡rio com shell personalizado
sudo adduser --disabled-password --gecos "" --shell /usr/bin/cvshell curriculo

# 2.2 - Definir senha (IMPORTANTE: Use uma senha forte!)
sudo passwd curriculo

# 2.3 - Criar diretÃ³rio home do usuÃ¡rio
sudo mkdir -p /home/curriculo
sudo chown curriculo:curriculo /home/curriculo
sudo chmod 750 /home/curriculo

## ğŸš PASSO 3: CRIAR SHELL PERSONALIZADO COM TRATAMENTO DE ERROS

# 3.1 - Criar o arquivo /usr/bin/cvshell
sudo tee /usr/bin/cvshell > /dev/null << 'EOF'
#!/bin/bash
# ========================================
# CVSHELL - Shell personalizado para currÃ­culo
# Sistema com tratamento robusto de erros
# ========================================

# ConfiguraÃ§Ãµes de seguranÃ§a
set -euo pipefail
umask 022

# VariÃ¡veis globais
CURRICULO_DIR="/opt/curriculo"
LOG_FILE="/var/log/cvshell.log"
MAX_TENTATIVAS=3
TENTATIVA=0

# FunÃ§Ã£o de log
log_evento() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$$] $1" | sudo tee -a "$LOG_FILE" >/dev/null 2>&1 || true
}

# FunÃ§Ã£o de limpeza na saÃ­da
cleanup() {
    log_evento "SessÃ£o finalizada para usuÃ¡rio: $(whoami)"
    exit 0
}

# Trap para capturar sinais e fazer limpeza
trap cleanup EXIT INT TERM

# FunÃ§Ã£o para verificar integridade do sistema
verificar_sistema() {
    local erros=0
    
    # Verificar se o diretÃ³rio existe
    if [[ ! -d "$CURRICULO_DIR" ]]; then
        echo "âŒ ERRO: DiretÃ³rio do currÃ­culo nÃ£o encontrado!"
        log_evento "ERRO: DiretÃ³rio $CURRICULO_DIR nÃ£o encontrado"
        ((erros++))
    fi
    
    # Verificar se o script principal existe
    if [[ ! -f "$CURRICULO_DIR/curriculo.sh" ]]; then
        echo "âŒ ERRO: Script principal nÃ£o encontrado!"
        log_evento "ERRO: Script principal curriculo.sh nÃ£o encontrado"
        ((erros++))
    fi
    
    # Verificar se o script Ã© executÃ¡vel
    if [[ ! -x "$CURRICULO_DIR/curriculo.sh" ]]; then
        echo "âŒ ERRO: Script principal sem permissÃ£o de execuÃ§Ã£o!"
        log_evento "ERRO: curriculo.sh sem permissÃ£o de execuÃ§Ã£o"
        ((erros++))
    fi
    
    # Verificar mÃ³dulos essenciais
    local modulos_obrigatorios=("01_sobre_mim.sh" "02_experiencia.sh" "06_contato.sh")
    for modulo in "${modulos_obrigatorios[@]}"; do
        if [[ ! -f "$CURRICULO_DIR/modulos/$modulo" ]]; then
            echo "âŒ ERRO: MÃ³dulo essencial nÃ£o encontrado: $modulo"
            log_evento "ERRO: MÃ³dulo $modulo nÃ£o encontrado"
            ((erros++))
        fi
    done
    
    return $erros
}

# FunÃ§Ã£o para exibir mensagem de erro amigÃ¡vel
mostrar_erro_sistema() {
    clear
    echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âš ï¸  SISTEMA INDISPONÃVEL                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                            â•‘
â•‘  O sistema de currÃ­culo estÃ¡ temporariamente indisponÃ­vel. â•‘
â•‘                                                            â•‘
â•‘  PossÃ­veis causas:                                         â•‘
â•‘  â€¢ ManutenÃ§Ã£o em andamento                                 â•‘
â•‘  â€¢ Arquivos corrompidos ou ausentes                       â•‘
â•‘  â€¢ Problemas de permissÃ£o                                  â•‘
â•‘                                                            â•‘
â•‘  Por favor, contate o administrador:                       â•‘
â•‘  ğŸ“§ gabriellucas2002br@outlook.com                         â•‘
â•‘                                                            â•‘
â•‘  Tentativa: $TENTATIVA/$MAX_TENTATIVAS                                      â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"
    echo "Aguarde 5 segundos para nova tentativa..."
    sleep 5
}

# FunÃ§Ã£o para executar o currÃ­culo com recuperaÃ§Ã£o de erro
executar_curriculo() {
    while [[ $TENTATIVA -lt $MAX_TENTATIVAS ]]; do
        ((TENTATIVA++))
        
        log_evento "Tentativa $TENTATIVA de execuÃ§Ã£o do currÃ­culo para $(whoami)"
        
        # Verificar integridade do sistema
        if verificar_sistema; then
            log_evento "Sistema verificado com sucesso"
            
            # Mudar para o diretÃ³rio do currÃ­culo
            cd "$CURRICULO_DIR" || {
                log_evento "ERRO: NÃ£o foi possÃ­vel acessar $CURRICULO_DIR"
                mostrar_erro_sistema
                continue
            }
            
            # Executar o currÃ­culo com timeout
            timeout 1800 bash "$CURRICULO_DIR/curriculo.sh" || {
                local exit_code=$?
                log_evento "ERRO: curriculo.sh falhou com cÃ³digo $exit_code"
                
                if [[ $exit_code -eq 124 ]]; then
                    echo "â° SessÃ£o expirada apÃ³s 30 minutos de inatividade."
                    sleep 3
                elif [[ $exit_code -eq 130 ]]; then
                    echo "ğŸ‘‹ SessÃ£o interrompida pelo usuÃ¡rio."
                    sleep 1
                else
                    mostrar_erro_sistema
                    continue
                fi
            }
            
            # Se chegou aqui, execuÃ§Ã£o foi bem-sucedida
            break
        else
            log_evento "Falha na verificaÃ§Ã£o do sistema"
            mostrar_erro_sistema
        fi
    done
    
    # Se esgotar tentativas
    if [[ $TENTATIVA -eq $MAX_TENTATIVAS ]]; then
        clear
        echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  ğŸš« SISTEMA FORA DO AR                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                            â•‘
â•‘  ApÃ³s $MAX_TENTATIVAS tentativas, o sistema nÃ£o conseguiu         â•‘
â•‘  inicializar corretamente.                                 â•‘
â•‘                                                            â•‘
â•‘  Entre em contato diretamente:                             â•‘
â•‘                                                            â•‘
â•‘  ğŸ“§ gabriellucas2002br@outlook.com                         â•‘
â•‘  ğŸ“± +55 (21) 99801-4245                                    â•‘
â•‘  ğŸ’¼ linkedin.com/in/gabsantanna                            â•‘
â•‘                                                            â•‘
â•‘  A conexÃ£o serÃ¡ encerrada em 10 segundos.                 â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"
        log_evento "CRÃTICO: Sistema falhou apÃ³s $MAX_TENTATIVAS tentativas para $(whoami)"
        sleep 10
    fi
}

# FunÃ§Ã£o principal
main() {
    # Registrar inÃ­cio da sessÃ£o
    log_evento "Nova sessÃ£o iniciada para usuÃ¡rio: $(whoami) de IP: ${SSH_CLIENT%% *}"
    
    # Verificar se Ã© o usuÃ¡rio correto
    if [[ "$(whoami)" != "curriculo" ]]; then
        log_evento "ALERTA: Tentativa de uso por usuÃ¡rio nÃ£o autorizado: $(whoami)"
        echo "âŒ Acesso negado. Este shell Ã© exclusivo para demonstraÃ§Ã£o do currÃ­culo."
        sleep 3
        exit 1
    fi
    
    # Limpar terminal
    clear
    
    # Mostrar banner inicial
    echo "
ğŸ” SessÃ£o segura iniciada - Shell restrito ativado
ğŸ‘¤ UsuÃ¡rio: $(whoami)
ğŸ•’ $(date '+%d/%m/%Y %H:%M:%S')
ğŸŒ IP: ${SSH_CLIENT%% *}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"
    sleep 2
    
    # Executar o sistema de currÃ­culo
    executar_curriculo
}

# Executar funÃ§Ã£o principal
main "$@"
EOF

# 3.2 - Tornar o shell executÃ¡vel
sudo chmod +x /usr/bin/cvshell

## ğŸ”’ PASSO 4: CONFIGURAÃ‡Ã•ES DE SEGURANÃ‡A SSH

# 4.1 - Backup da configuraÃ§Ã£o SSH
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)

# 4.2 - Adicionar configuraÃ§Ãµes especÃ­ficas para o usuÃ¡rio curriculo
sudo tee -a /etc/ssh/sshd_config > /dev/null << 'EOF'

# ========================================
# CONFIGURAÃ‡Ã•ES ESPECÃFICAS - USUÃRIO CURRICULO
# ========================================

# ConfiguraÃ§Ã£o para usuÃ¡rio curriculo - CurrÃ­culo Interativo
Match User curriculo
    # ForÃ§ar execuÃ§Ã£o apenas do shell personalizado
    ForceCommand /usr/bin/cvshell
    
    # Permitir TTY para interatividade
    PermitTTY yes
    
    # Desabilitar recursos desnecessÃ¡rios
    X11Forwarding no
    AllowTcpForwarding no
    AllowStreamLocalForwarding no
    PermitTunnel no
    
    # ConfiguraÃ§Ãµes de sessÃ£o
    ClientAliveInterval 300
    ClientAliveCountMax 2
    
    # Permitir apenas autenticaÃ§Ã£o por senha (ou configure chaves se preferir)
    AuthenticationMethods password
    
    # DiretÃ³rio chroot (opcional - maior seguranÃ§a)
    # ChrootDirectory /home/curriculo
EOF

# 4.3 - Validar configuraÃ§Ã£o SSH
sudo sshd -t

# 4.4 - Reiniciar SSH se configuraÃ§Ã£o estiver vÃ¡lida
if sudo sshd -t; then
    sudo systemctl restart ssh
    echo "âœ… SSH configurado e reiniciado com sucesso"
else
    echo "âŒ ERRO na configuraÃ§Ã£o SSH. Verifique o arquivo!"
    exit 1
fi

## ğŸ“Š PASSO 5: CONFIGURAR LOGGING E MONITORAMENTO

# 5.1 - Criar arquivo de log
sudo touch /var/log/cvshell.log
sudo chown root:adm /var/log/cvshell.log
sudo chmod 644 /var/log/cvshell.log

# 5.2 - Configurar rotaÃ§Ã£o de logs
sudo tee /etc/logrotate.d/cvshell > /dev/null << 'EOF'
/var/log/cvshell.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root adm
}
EOF

## ğŸ§ª PASSO 6: TESTES DE VALIDAÃ‡ÃƒO

# 6.1 - Testar o shell diretamente
echo "ğŸ§ª Testando o shell personalizado..."
sudo -u curriculo /usr/bin/cvshell --test 2>/dev/null || echo "Teste concluÃ­do"

# 6.2 - Testar conexÃ£o SSH local
echo "ğŸ”Œ Para testar SSH localmente, execute:"
echo "ssh curriculo@localhost"
echo

## ğŸ“‹ PASSO 7: INFORMAÃ‡Ã•ES FINAIS

echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   âœ… CONFIGURAÃ‡ÃƒO CONCLUÃDA                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                            â•‘
â•‘  UsuÃ¡rio criado: curriculo                                 â•‘
â•‘  Shell personalizado: /usr/bin/cvshell                     â•‘
â•‘  DiretÃ³rio: /opt/curriculo                                 â•‘
â•‘  Logs: /var/log/cvshell.log                                â•‘
â•‘                                                            â•‘
â•‘  Para acessar:                                             â•‘
â•‘  ssh curriculo@SEU_SERVIDOR_IP                             â•‘
â•‘                                                            â•‘
â•‘  Para monitorar:                                           â•‘
â•‘  sudo tail -f /var/log/cvshell.log                         â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

## ğŸ”§ COMANDOS ÃšTEIS PARA ADMINISTRAÃ‡ÃƒO:

# Verificar status do usuÃ¡rio
# sudo passwd -S curriculo

# Monitorar logs em tempo real
# sudo tail -f /var/log/cvshell.log

# Verificar conexÃµes ativas
# sudo netstat -tuln | grep :22

# Testar configuraÃ§Ã£o SSH
# sudo sshd -t

# Reiniciar SSH
# sudo systemctl restart ssh

# Verificar logs SSH
# sudo journalctl -u ssh -f

# Remover usuÃ¡rio (se necessÃ¡rio)
# sudo userdel -r curriculo
# sudo rm /usr/bin/cvshell

## âš ï¸ OBSERVAÃ‡Ã•ES IMPORTANTES:

# 1. SEGURANÃ‡A:
#    - O usuÃ¡rio 'curriculo' sÃ³ pode executar o shell personalizado
#    - Sistema com timeout automÃ¡tico de 30 minutos
#    - Logs detalhados de todas as aÃ§Ãµes
#    - Tentativas limitadas de recuperaÃ§Ã£o de erro

# 2. MONITORAMENTO:
#    - Todos os acessos sÃ£o registrados em /var/log/cvshell.log
#    - Inclui IP do cliente, horÃ¡rio e eventos do sistema

# 3. RECUPERAÃ‡ÃƒO DE ERRO:
#    - Sistema tenta 3 vezes antes de falhar completamente
#    - VerificaÃ§Ãµes automÃ¡ticas de integridade
#    - Mensagens amigÃ¡veis para o usuÃ¡rio

# 4. MANUTENÃ‡ÃƒO:
#    - Atualize os arquivos em /opt/curriculo conforme necessÃ¡rio
#    - Monitore os logs regularmente
#    - Configure backup dos arquivos importantes
